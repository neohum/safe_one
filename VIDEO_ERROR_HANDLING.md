# 영상 오류 자동 처리 기능

## 개요

YouTube 영상이 재생되지 않을 때 자동으로 대체 영상을 찾아서 재생하는 기능입니다.

## 작동 방식

### 1. 영상 오류 감지

**YoutubePlayer 컴포넌트**에서 다음 방법으로 영상 오류를 감지합니다:

1. **YouTube oEmbed API 다중 확인**
   - 즉시 확인: 컴포넌트 마운트 시 즉시 API 호출
   - 주기적 확인: 3초마다 최대 3회 반복 확인
   - 최종 확인: 10초 후 마지막 확인
   - 감지 가능한 오류:
     - ❌ 삭제된 동영상
     - ❌ 비공개 동영상
     - ❌ 지역 제한 동영상
     - ❌ 저작권 문제로 차단된 동영상

2. **iframe onError 이벤트**
   - iframe 로드 실패 시 즉시 감지

3. **빠른 감지**
   - 기존: 10초 후 1회 확인
   - 개선: 즉시 + 3초마다 3회 + 10초 후 최종 확인
   - 비공개 동영상을 3초 이내에 감지 가능

### 2. 대체 영상 선택 로직 (최신 영상 우선)

#### Home 페이지 (랜덤 재생)
1. 오류 발생한 영상을 제외 목록에 추가
2. **같은 키워드**의 영상 중 **최신 영상** 우선 검색
   - 각 영상의 재생 가능 여부 확인
   - ID가 높은 순으로 정렬 (최신 데이터)
   - 재생 가능한 첫 번째 영상 선택
3. 같은 키워드가 없으면 **아무 최신 영상**이나 선택
   - 상위 10개 최신 영상 중 재생 가능한 영상 선택
4. 모든 영상이 제외되면 제외 목록 초기화

#### Select 페이지 (선택 재생)
1. 오류 발생한 영상을 제외 목록에 추가
2. **같은 키워드**의 영상 중 **최신 영상** 우선 검색
   - 각 영상의 재생 가능 여부 확인
   - ID가 높은 순으로 정렬 (최신 데이터)
   - 재생 가능한 첫 번째 영상 선택
3. 같은 키워드가 없으면 **목록으로 돌아가기**

### 3. 사용자 피드백

영상 오류 발생 시 다음과 같은 메시지를 표시합니다:

```
⚠️ 영상을 불러올 수 없습니다. 다른 영상을 찾고 있습니다...
```

## 구현 세부사항

### videoSelection.ts (새로 추가)

**유틸리티 함수:**

1. **`findReplacementVideo(errorPost, allPosts, excludedIds)`**
   - 같은 키워드의 대체 영상 찾기
   - 각 영상의 재생 가능 여부 확인 (YouTube oEmbed API)
   - ID가 높은 순으로 정렬 (최신 데이터 우선)
   - 재생 가능한 첫 번째 영상 반환

2. **`findAnyReplacementVideo(allPosts, excludedIds)`**
   - 아무 영상이나 찾기
   - ID가 높은 순으로 정렬
   - 상위 10개 중 재생 가능한 영상 선택

3. **`isVideoAvailable(post)`**
   - YouTube oEmbed API로 재생 가능 여부 확인
   - 200 OK: 재생 가능
   - 401/403/404: 재생 불가

### YoutubePlayer.tsx

```typescript
interface YoutubePlayerProps {
  url: string;
  post?: Post;
  autoplay?: boolean;
  height?: string;
  onVideoError?: (post: Post) => void;  // 새로 추가
}
```

**주요 기능:**
- `videoError` state: 오류 상태 관리
- `retryCount` state: 재시도 횟수 제한 (최대 1회)
- `errorTimeoutRef`: 10초 후 최종 확인 타이머
- `checkIntervalRef`: 3초마다 반복 확인 인터벌
- `checkVideoAvailability()`: YouTube oEmbed API로 영상 확인
  - 즉시 실행
  - 3초마다 3회 반복
  - 10초 후 최종 확인
- `handleVideoError(reason)`: 부모 컴포넌트에 오류 알림
  - 타이머 정리
  - 오류 이유 로깅

### Home.tsx

**주요 기능:**
- `excludedIds` state: 오류 발생한 영상 ID 목록
- `getRandomPost(excludeIds)`: 제외 목록을 고려한 랜덤 선택
- `handleVideoError(errorPost)`: 대체 영상 찾기 (async)

**대체 영상 선택 우선순위:**
1. 같은 키워드의 **최신** 영상 (재생 가능 확인)
2. 아무 **최신** 영상이나 (상위 10개 중 재생 가능한 영상)
3. 제외 목록 초기화 후 다시 선택

**콘솔 로그 예시:**
```
대체 영상 검색 시작: 사용 후 전기코드 뽑고 정리하기 (키워드: 가전제품)
같은 키워드의 영상 5개 발견
✓ 재생 가능: 전기 플러그 안전하게 사용하기
✗ 재생 불가: 전기 콘센트 주의사항
✅ 선택된 대체 영상: 전기 플러그 안전하게 사용하기 (ID: 150)
```

### Select.tsx

**주요 기능:**
- `excludedIds` state: 오류 발생한 영상 ID 목록
- `handleVideoError(errorPost)`: 대체 영상 찾기 (async)

**대체 영상 선택 우선순위:**
1. 같은 키워드의 **최신** 영상 (재생 가능 확인)
2. 없으면 목록으로 돌아가기 (alert 표시)

## 장점

### 1. 사용자 경험 개선
- ✅ 영상 오류 시 자동으로 대체 영상 재생
- ✅ **최신 영상 우선 재생**
- ✅ 수동 신고 불필요
- ✅ 끊김 없는 시청 경험

### 2. 관리 효율성
- ✅ 백엔드 API 불필요 (이메일 신고 기능 제거)
- ✅ 서버 비용 절감
- ✅ 간단한 구조

### 3. 자동 복구
- ✅ 같은 키워드의 **최신** 영상으로 대체
- ✅ 교육 내용의 연속성 유지
- ✅ 재생 가능 여부 사전 확인

### 4. 스마트 선택
- ✅ ID 기반 최신성 판단 (높은 ID = 최신 데이터)
- ✅ 상위 10개 최신 영상 중 재생 가능한 영상 선택
- ✅ 각 영상의 재생 가능 여부 실시간 확인

## 제거된 기능

다음 기능들이 제거되었습니다:

- ❌ 이메일 신고 기능
- ❌ 신고 모달 UI
- ❌ Express 백엔드 서버
- ❌ Vercel Serverless Functions
- ❌ Resend 이메일 서비스

## 테스트 방법

### 1. 개발 환경에서 테스트

```bash
cd frontend
npm run dev
```

### 2. 영상 오류 시뮬레이션

잘못된 YouTube URL을 데이터에 추가하여 테스트:

```typescript
{
  id: 999,
  key_words: '테스트',
  contents: '오류 테스트 영상',
  url: 'https://www.youtube.com/watch?v=INVALID_ID',
  youtube_id: 'INVALID_ID',
  channel_name: '테스트',
  play_time: 1
}
```

### 3. 확인 사항

- [ ] 즉시 영상 확인 (0초)
- [ ] 3초마다 반복 확인 (3초, 6초, 9초)
- [ ] 최종 확인 (10초)
- [ ] 비공개 동영상 3초 이내 감지
- [ ] 삭제된 동영상 즉시 감지
- [ ] 경고 메시지 표시
- [ ] 같은 키워드의 대체 영상 자동 재생
- [ ] 제외 목록에 오류 영상 추가
- [ ] 콘솔에 오류 로그 출력 (오류 이유 포함)

## 향후 개선 사항

### 1. 오류 로깅
- 오류 발생한 영상 정보를 localStorage에 저장
- 관리자 페이지에서 확인 가능

### 2. 사용자 피드백 개선
- 대체 영상으로 전환 시 토스트 메시지
- "이 영상이 재생되지 않아 비슷한 영상을 찾았습니다"

### 3. 스마트 대체 영상 선택
- 채널명도 고려
- 재생시간 유사도 고려
- 인기도 기반 선택

## 배포

### Verpex Shared Hosting

이제 백엔드 없이 프론트엔드만 배포하면 됩니다:

```bash
cd frontend
npm run build:prod
```

`dist/` 폴더를 Verpex에 업로드하면 완료!

### 비용

- ✅ **완전 무료** (백엔드 서버 불필요)
- ✅ Verpex 호스팅 비용만 발생

## 문의

neohum77@gmail.com

